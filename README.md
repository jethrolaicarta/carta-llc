# LLCWebService
This is an experimental project for prototyping. This is NOT the official LLC project

# Service API Specification
For usage and API Specifications, See [Rest API Specificiation](docs/REST_API_SPEC.md) or simply [start a local service instance](#run-locally) and visit [localhost:8080/swagger-ui.html](http://localhost:8080/swagger-ui.html)

# <a name="run-locally">Build and Run Locally</a>
For local development, you have two options:
- a local SpringBoot Java application
- a docker container

### Prerequisites
- Java11
- Maven 3.6.0+
- (If you are running this as a docker container) [Docker](https://runnable.com/docker/install-docker-on-macos)

### Run As SpringBoot Application
**Option 1:** Maven Spring-boot Plugin ( preferred for local development. See **_[Pro Tip 1](#pro-tip-1)_** )
```
mvn spring-boot:run
```
**Option 2:** Standalone Java Application
```
mvn clean package; java -jar target/carta-llc-0.1.0-SNAPSHOT.jar
```

**_<span style="color:pink"><a name="pro-tip-1">Pro Tip 1</a><br/></span>_**
Using Maven spring-boot plugin is preferred for development because [Spring Developer Tools](https://docs.spring.io/spring-boot/docs/current/reference/html/using-boot-devtools.html) is used. One important feature is automatic restart. When any file on the class path is changed, a restart will be automatically triggered without re-compile and re-start the application manually to save precious development time.

### Run As Docker Container
There are two steps: build a docker image and then run a docker container

```shell
mvn clean package dockerfile:build
# this is equivalent to:
# mvn clean package; docker build -t carta/carta-llc .

docker run --name carta-llc --rm -p 8080:8080 carta/carta-llc
```

### Verify Local Instance
```shell
curl localhost:8080
```
Or simply open [localhost:8080](localhost:8080) on your browser.
If you see something like:
```json
{
  "status": {
    "server": "OK"
  }
}
```

Congratulation! You just got the base springboot service running locally.

# Test and Coverage Report

### Unit Tests
All maven phases after _test_ will execute the all unit tests without integration tests e.g. _`mvn install`_, _`mvn test`_, _`mvn package`_.

### Integration Tests
Use maven profile _"AllTest"_ to include integration tests. e.g. _`mvn test -P AllTest`_.

### Test Coverage Report
Test coverage report ui generated by jacoco can be simply opened on your default browser by
```shell
open target/jacoco-ut/index.html
```

# Development and Debugging Features
### Manage Logging Level
You can simple send a HTTP POST request to _/manage/loggers/{logger name}_ with a simple json body.
The input logger name can also be a java package name. e.g. _com.carta.llc_. Full list of loggers are available at _[/manage/loggers](localhost:8080/manage/loggers)_.
json Body to post:
```json
{
  "configuredLevel": "DEBUG",
}
```
This is achieved via SpringBoot actuator. (See **_[Pro Tip 2](#pro-tip-2)_**)
#### Example:
When an instance is started, the level all application loggers is set to **INFO** by default.
Visit _[/manage/loggers](localhost:8080/manage/loggers)_ or run `curl localhost:8080/manage/loggers`, you should see the logger _com.carta.llc_ is set to level **INFO**.
Now, run
```shell
curl -X "POST" "localhost:8080/manage/loggers/com.carta" -H "Content-Type: application/json; charset=utf-8" -d '{"configuredLevel":"DEBUG"}'
```
visit _[/manage/loggers](localhost:8080/manage/loggers)_ on browswer or run `curl localhost:8080/manage/loggers` again, and you will see the logger _com.carta.llc_ is now set to level **DEBUG**.

**_<span style="color:pink"><a name="pro-tip-2">Pro Tip 2</a><br/></span>_**
Logger management is done via SpringBoot Actuator. Logger management is merely one of many production ready feature that actuator offers. All actuator endpoints are enabled with _"/manage"_ prefix e.g. aforementioned _[/manage/loggers](localhost:8080/manage/loggers)_. [Learn more about SpringBoot actuator endpoints](https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-endpoints.html).

### Eclipse Integration
You can also debug using Eclipse. Simply run debug the service as a standard java application with com.carta.llc.Application as main class. Eclipse STS plugin is highly recommended.

### Open a port for remote debugging
You can uncomment the jvm arguments in spring-boot-maven-plugin of pom.xml to open debugging port

Alternatively,
```shell
java -Xdebug -Xrunjdwp:server=y,transport=dt_socket,address=5005,suspend=n -jar target/carta-llc-0.1.0-SNAPSHOT.jar
```

## H2 In-memory Database and Seed Data
By default, when you stand up a locally instance, a H2 database schema will be created with seed data to ease the persistence resource setup.
SpringBoot's H2 console is also enabled by default. Simply open [localhost:8080/h2-console](localhost:8080/h2-console) while local instance is running.
The schema is defined in _[/src/main/resources/schema.sql](/src/main/resources/schema.sql)_ where the seed data is injected by _[/src/main/resources/data.sql](/src/main/resources/data.sql)_

# Known Issues and Upcoming Improvements
### JDK 11
Java 11 was originally used to build and run this service. We will update this base service to use Java 13 in the future. You can manage different JDK versions using either via [jEnv](http://www.jenv.be/) or [my preferred hack](docs/ManageMultipleJavas.md).

### SpringBoot Actuator & Swagger UI
Accessing actuator endpoint via swagger is not working properly at the moment due to [this issue](https://github.com/springfox/springfox/issues/2390). Use other methods(curl, browswer etc.) if you need to access actuator features.
